<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BLE RC Car Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <script src="joy.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #fafafa; }
    #joyDiv { width: 300px; height: 300px; margin: 20px auto; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px; border-radius: 12px; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üöó BLE RC Car</h1>
  <div id="joyDiv"></div>
  <button id="connect">üîó Connect BLE</button>
  <p id="status">Not connected</p>

  <script>
    const bluetoothConfig = {
      serviceId: 0xFFF0,
      batt: 0xFFF1,
      control: 0xFFF2,
    };
    let joystick, btChar, timer;
    
    // --- BLE Connect ---
    document.getElementById('connect').addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [bluetoothConfig.serviceId] }],
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(bluetoothConfig.serviceId);
        btChar = await service.getCharacteristic(bluetoothConfig.control);

        document.getElementById('status').textContent = '‚úÖ Connected';
        console.log('Connected to BLE');

        // –∞–≤—Ç–æ–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ
        device.addEventListener('gattserverdisconnected', () => {
          clearInterval(timer);
          document.getElementById('status').textContent = '‚ùå Disconnected';
        });

        // –∑–∞–ø—É—Å–∫ –æ–ø—Ä–æ—Å–∞
        if (timer) clearInterval(timer);
        timer = setInterval(sendPacket, 50);
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = '‚ö†Ô∏è Connection failed ' + e;
      }
    });

    // --- Joystick ---
    joystick = new JoyStick('joyDiv', { internalFillColor: '#008cff' }, function(stickData) {
      window.lastX = stickData.x; // –ø–æ–≤–æ—Ä–æ—Ç
      window.lastY = stickData.y; // —Å–∫–æ—Ä–æ—Å—Ç—å
    });

      function constrain(Value, Min, Max) {
        return (Value < Min) ? Min : (Value > Max) ? Max : Value;
      }

    // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
    const DIR_NONE     =  0
    const DIR_FORWARD  =  1
    const DIR_BACKWARD =  2

    // –ü–æ–≤–æ—Ä–æ—Ç—ã
    const TURN_NONE  =    0
    const TURN_RIGHT =    1
    const TURN_LEFT  =    2  

    // --- Send data loop ---
    function sendPacket() {
      if (!btChar) return;

      let lastX = constrain(window.lastX,-100,100);
      let lastY = constrain(window.lastY,-100,100);

      const speed = Math.round((Math.abs(lastY || 0) / 100) * 255);
      const dir = (lastY || 0) >= 0 ? DIR_FORWARD : DIR_BACKWARD;

      let turn = TURN_NONE;
      if ((lastX || 0) < -20) turn = TURN_RIGHT;
      else if ((lastX || 0) > 20) turn = TURN_LEFT;

      const packet = new Uint8Array([speed, dir, turn]);
      console.log(speed, dir, turn);
      btChar.writeValueWithoutResponse(packet).catch(console.error);
    }

    // --- PWA Install Support ---
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(() => (document.getElementById('status').textContent = '‚úÖ Service Worker registered'))
            .catch(err => (document.getElementById('status').textContent = 'SW registration failed:' + err));
        });
      }
  </script>
</body>
</html>

