<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CH582F RC Car</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <script src="joy.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #fafafa; }
    #joyDiv { width: 300px; height: 300px; margin: 20px auto; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px; border-radius: 12px; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üöó CH582F RC Car</h1>
  <div>
      <span id="battery">--</span>
  </div>
  <button id="connect">üîó Connect BLE</button>
  <p id="status">Not connected</p>
  <div id="joyDiv"></div>
  <script>
    const bluetoothConfig = {
      serviceId: 0xFFF0,
      batt: 0xFFF1,
      control: 0xFFF2,
    };
    let joystick, btChar, batteryChar, timer;
    
    // --- BLE Connect ---
    document.getElementById('connect').addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [bluetoothConfig.serviceId] }],
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(bluetoothConfig.serviceId);
        btChar = await service.getCharacteristic(bluetoothConfig.control);
        batteryChar = await service.getCharacteristic(bluetoothConfig.batt);
         // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ "value changed"
        batteryChar.addEventListener('characteristicvaluechanged', batteryNotification);
        await batteryChar.startNotifications();
        //await batteryChar.readValue(); // –≤—ã–∑–æ–≤ —á—Ç–µ–Ω–∏–µ
        document.getElementById('status').textContent = '‚úÖ Connected';
        console.log('Connected to BLE');

        // –∞–≤—Ç–æ–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ
        device.addEventListener('gattserverdisconnected', () => {
          clearInterval(timer);
          document.getElementById('status').textContent = '‚ùå Disconnected';
          batteryChar.removeEventListener('characteristicvaluechanged', batteryNotification);
        });

        // –∑–∞–ø—É—Å–∫ –æ–ø—Ä–æ—Å–∞
        if (timer) clearInterval(timer);
        timer = setInterval(sendPacket, 50);
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = '‚ö†Ô∏è Connection failed ' + e;
      }
    });

    // --- Joystick ---
    joystick = new JoyStick('joyDiv', { internalFillColor: '#008cff' }, function(stickData) {
      window.lastX = stickData.x; // –ø–æ–≤–æ—Ä–æ—Ç
      window.lastY = stickData.y; // —Å–∫–æ—Ä–æ—Å—Ç—å
    });

      function constrain(Value, Min, Max) {
        return (Value < Min) ? Min : (Value > Max) ? Max : Value;
      }

    function arraysEqual(a, b) {
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i++) if (a[i] !== b[i]) return false;
      return true;
    }                               
    // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
    const DIR_NONE     =  0
    const DIR_FORWARD  =  1
    const DIR_BACKWARD =  2

    // –ü–æ–≤–æ—Ä–æ—Ç—ã
    const TURN_NONE  =    0
    const TURN_RIGHT =    1
    const TURN_LEFT  =    2  

    let lastPacket = new Uint8Array([0, 0, 0]);
    // --- Send data loop ---
    function sendPacket() {
      if (!btChar) return;

      let lastX = constrain(window.lastX,-100,100);
      let lastY = constrain(window.lastY,-100,100);

      const speed = Math.round((Math.abs(lastY || 0) / 100) * 255);
      const dir = (lastY || 0) >= 0 ? DIR_FORWARD : DIR_BACKWARD;

      let turn = TURN_NONE;
      if ((lastX || 0) < -20) turn = TURN_RIGHT;
      else if ((lastX || 0) > 20) turn = TURN_LEFT;

      const packet = new Uint8Array([speed, dir, turn]);

      if (!arraysEqual(packet, lastPacket)) {
        console.log(speed, dir, turn);
        lastPacket = packet;
        btChar.writeValueWithoutResponse(packet).catch(console.error);
      }
    }

     const batteryConfig = {
        minVoltage: 3.0,
        maxVoltage: 4.2,
        adcMultiplier: 3.3 / 4096,  // 0.00080566
        batteryMultiplier: 1        // 1 –±–µ–∑ –¥–µ–ª–∏—Ç–µ–ª—è, –∞ –µ—Å–ª–∏ —Å—Ç–æ–∏—Ç –¥–µ–ª–∏—Ç–µ–ª—å —Ç–æ (R1+R2)/R2
      };

    function batteryNotification(event) {
      const value = event.target.value;
      // —á–∏—Ç–∞–µ–º –æ–¥–Ω–æ 16-–±–∏—Ç–Ω–æ–µ —á–∏—Å–ª–æ, little-endian
      const adc = value.getUint16(0, /*littleEndian=*/true);
      console.log("batteryNotification adc: ", adc);

      const { adcMultiplier, batteryMultiplier, minVoltage, maxVoltage } = batteryConfig;
      const battV = adc * adcMultiplier * batteryMultiplier;
      const pct = Math.round(
        Math.max(0, Math.min(100,
          (battV - minVoltage) / (maxVoltage - minVoltage) * 100
        ))
      );
      const battery = document.getElementById('battery')
      battery.textContent = "Battery " + battV.toFixed(2) + "V / " + pct +"%";
    }


    // --- PWA Install Support ---
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(() => (document.getElementById('status').textContent = '‚úÖ Service Worker registered'))
            .catch(err => (document.getElementById('status').textContent = 'SW registration failed:' + err));
        });
      }
  </script>
</body>
</html>

